import win.ui;
import fonts.fontAwesome;
/*DSG{{*/
var winform = win.form(text="aardio - AI ç¼–ç¨‹åŠ©æ‰‹";right=759;bottom=620;bgcolor=0xFAF9F8;border="none")
winform.add(
bk={cls="bk";text="aardio - AI ç¼–ç¨‹åŠ©æ‰‹";left=21;top=3;right=198;bottom=23;align="left";dl=1;dt=1;z=15};
bkPrompt={cls="plus";left=5;top=461;right=754;bottom=615;bgcolor=0xFFFFFF;border={radius=12};clip=1;clipBk=false;db=1;disabled=1;dl=1;dr=1;z=1};
bkTitle={cls="bk";left=0;top=0;right=764;bottom=27;bgcolor=0xDBDAD9;dl=1;dr=1;dt=1;forecolor=0x5C5B5B;linearGradient=0;z=2};
btnClear={cls="plus";text="æ¸…é™¤";left=601;top=586;right=659;bottom=615;align="left";bgcolor=0xFFFFFF;color=0x3C3C3C;db=1;dr=1;font=LOGFONT(h=-13);iconStyle={align="left";font=LOGFONT(h=-13;name='FontAwesome');padding={left=8}};iconText='\uF014';notify=1;textPadding={left=25};z=5};
btnCopy={cls="plus";text="å¤åˆ¶";left=315;top=586;right=379;bottom=615;align="left";bgcolor=0xFFFFFF;color=0x3C3C3C;db=1;disabled=1;dr=1;font=LOGFONT(h=-13);iconStyle={align="left";font=LOGFONT(h=-13;name='FontAwesome');padding={left=8}};iconText='\uF0C5';notify=1;textPadding={left=25};z=10};
btnSearch={cls="plus";text="è”ç½‘";left=17;top=586;right=78;bottom=615;align="left";bgcolor=0xFFFFFF;color=0x3C3C3C;db=1;dl=1;font=LOGFONT(h=-13);iconStyle={align="left";font=LOGFONT(h=-13;name='FontAwesome');padding={left=8}};iconText='\uF26B';notify=1;textPadding={left=25};z=16};
btnSend={cls="plus";text="é—® AI";left=668;top=586;right=740;bottom=615;align="left";bgcolor=0xFFFFFF;color=0x3C3C3C;db=1;dr=1;font=LOGFONT(h=-13);iconColor=0x5757FF;iconStyle={align="left";font=LOGFONT(h=-13;name='FontAwesome');padding={left=8}};iconText='\uF0AA';notify=1;textPadding={left=25};z=4};
btnSetting={cls="plus";text="è®¾ç½®";left=81;top=586;right=148;bottom=615;align="left";bgcolor=0xFFFFFF;color=0x3C3C3C;db=1;dl=1;font=LOGFONT(h=-13);iconStyle={align="left";font=LOGFONT(h=-13;name='FontAwesome');padding={left=8}};iconText='\uF013';notify=1;textPadding={left=25};z=6};
btnSnap={cls="plus";left=277;top=587;right=310;bottom=616;align="left";bgcolor=0xFFFFFF;color=0x3C3C3C;db=1;disabled=1;dr=1;font=LOGFONT(h=-13);iconStyle={font=LOGFONT(h=-13;name='FontAwesome')};iconText='\uF030';notify=1;textPadding={left=25};z=12};
chkFix={cls="plus";text="æ›´æ­£";left=388;top=586;right=448;bottom=615;align="left";bgcolor=0xFFFFFF;db=1;dr=1;font=LOGFONT(h=-13);iconStyle={align="left";font=LOGFONT(h=-14;name='FontAwesome')};iconText='\uF0C8 ';notify=1;textPadding={left=24};z=11};
cmbAgent={cls="combobox";left=151;top=590;right=275;bottom=612;db=1;dl=1;edge=1;items={};mode="dropdownlist";z=17};
editMaxTokens={cls="edit";left=530;top=590;right=573;bottom=613;align="right";db=1;dr=1;edge=1;z=8};
editPrompt={cls="richedit";left=8;top=466;right=751;bottom=580;autohscroll=false;bgcolor=0xFFFFFF;db=1;dl=1;dr=1;link=1;multiline=1;vscroll=1;z=3};
spinMaxTokens={cls="spin";left=574;top=591;right=594;bottom=613;db=1;dr=1;z=7};
splitter={cls="splitter";left=-7;top=457;right=758;bottom=462;bgcolor=0xD1D1D1;db=1;dl=1;dr=1;horz=1;z=13};
static={cls="static";text="å›å¤é•¿åº¦ï¼š";left=455;top=586;right=521;bottom=615;align="right";bgcolor=0xFFFFFF;center=1;db=1;dr=1;z=9};
wndBrowser={cls="custom";text="è‡ªå®šä¹‰æ§ä»¶";left=5;top=27;right=753;bottom=455;ah=1;db=1;dl=1;dr=1;dt=1;z=14}
)
/*}}*/

import fsys.table;
config = fsys.table(io.appData("aardio/ide/aiChat/~"))

if(!config.itemData) {
	config.itemNames={[1]="é»˜è®¤"};
	config.itemData={[1]={proxy="";temperature=0.4;key='\0\1\96';model="aardio";url="https://ai.aardio.com/api/v1/";systemPrompt="";msgLimit=15}};
	..table.assign(config,config.itemData[1]);
	config.selItem=1;
}

var aiChatConfig = ..table.assign({},config);

//åˆ›å»ºæ˜¾ç¤ºèŠå¤©æ¶ˆè™‘çš„ Web æµè§ˆå™¨çª—å£
import web.form.chat;
var wb = web.form.chat(winform.wndBrowser);
wb.enableKatex(aiChatConfig.katex);

//æ¸…é™¤ä¸Šä¸‹æ–‡
var resetMessages = function(){
 
	wb.clear(); 

	//è‡ªåŠ¨ç”Ÿæˆ aardio ç¼–ç¨‹åŠ©æ‰‹ç³»ç»Ÿæç¤ºè¯
	wb.aardioSystem(aiChatConfig.systemPrompt);	

	wb.aiSystemPropmptSupperHotkeys = null;
	wb.aiSystemPropmptStringPatterns = null;
	wb.aiSystemPropmptWebView = null;
	wb.aiSystemPropmptPython = null; 
	wb.aiSystemPropmptWinform = null;
	wb.aiSystemPropmptNet = null;
	wb.aiSystemPropmptPlus = null;
	wb.aiSystemPropmptFile = null;
	wb.aiSearched = null;

	import ide;
	var ideEnv = '## å½“å‰è¿è¡Œç¯å¢ƒ\r\n- å½“å‰ aardio ä¸»ç‰ˆæœ¬å·ä¸ºï¼š' + (ide.getConfig("version") || (_AARDIO_VERSION));
	ideEnv = ideEnv ++ '\r\n- å½“å‰æ—¶é—´ä¸ºï¼š' + tostring(..time());
	ideEnv = ideEnv ++ '\r\n- å½“å‰è¿›ç¨‹ EXE æ‰§è¡Œæ–‡ä»¶åä¸ºï¼š"' + ..io._exefile + '"';
	ideEnv = ideEnv ++ '\r\n- å½“å‰æ“ä½œç³»ç»Ÿä¸ºï¼š"' + ..win.version.format() + '"';
	
	var projPath = ide.getProjectPath();
	if(!#projPath) return wb.system(ideEnv);
	
	import fsys.file;
	var file = fsys.file(projPath,"r");
	if(!file) return;
	
	if(file.size() > 20000){
		file.close();
		return;
	}
	
	var xml = file.readAll();
	
	if(string.indexOf(xml,"\node_modules\")){
		winform.msgboxErr("
è¯·ä¸è¦å°† node_modules ç›®å½•æ·»åŠ åˆ° aardio å·¥ç¨‹ã€‚

aardio å·¥ç¨‹çš„ Web å‰ç«¯æºç ç›®å½•è¯·è®¾ç½®ã€å¿½ç•¥ç›®å½•ã€‘ä¸º true ã€‚
å‰ç«¯å‘å¸ƒæ–‡ä»¶ç›®å½•è¯·è®¾ç½®ã€æœ¬åœ°æ„å»ºã€‘ä¸º true ã€‚

å¦åˆ™å°†ä¸¥é‡å½±å“æ€§èƒ½ä¸ AI ç›¸å…³åŠŸèƒ½ã€‚"); 
	}
	else {
		
		var project = '\r\n\r\n'+"
## aardio æºæ–‡ä»¶ä¸å·¥ç¨‹æ–‡ä»¶

aardio ä»£ç æ–‡ä»¶çš„åç¼€åä¸º `.aardio`ï¼Œå¯åŒ…å« UTF-8 ç¼–ç çš„æºä»£ç ï¼Œä¹Ÿå¯ä»¥åŒ…å«ç¼–è¯‘åçš„äºŒè¿›åˆ¶ä»£ç ã€‚

aardio å·¥ç¨‹æ–‡ä»¶çš„åç¼€åä¸º `.aproj`ï¼Œå…¶å†…å®¹æ˜¯ XML æ ¼å¼çš„å·¥ç¨‹é…ç½®ï¼Œä¹Ÿä½¿ç”¨  UTF-8 ç¼–ç  ã€‚  
"

		project = project + '\r\n\r\n**ç”¨æˆ·å½“å‰åœ¨ aardio å¼€å‘ç¯å¢ƒä¸­æ‰“å¼€çš„å·¥ç¨‹æ–‡ä»¶è·¯å¾„æ˜¯: **"'+projPath+'"\r\n'
	 	
		project = project + '\r\n\r\n**ç”¨æˆ·å½“å‰æ‰“å¼€çš„å·¥ç¨‹æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š**'
		
		project = project + '\r\n\r\n```xml\r\n' + ..string.removeBom(xml) +  '\r\n```\r\n\r\n'
		
		var desc = /*****
	
**å·¥ç¨‹æ–‡ä»¶å„ XML èŠ‚ç‚¹çš„ä½œç”¨ä¸å«ä¹‰ï¼š**
	
- project å…ƒç´ æŒ‡å®šå·¥ç¨‹é…ç½®ï¼Œå¹¶ä½œä¸ºå·¥ç¨‹æ ¹ç›®å½•åŒ…å«å…¶ä»– folder æˆ– file å…ƒç´ ã€‚

    project å…ƒç´ çš„å±æ€§ ui æŒ‡å®šå›¾å½¢ç•Œé¢ã€‚ 

        * å¦‚æœ ui ä¸º "win" åˆ™ä¸ºå›¾å½¢ç•Œé¢å‘å¸ƒåè¿è¡Œé»˜è®¤ä¸æ˜¾ç¤ºæ§åˆ¶å°ã€‚
        * å¦‚æœ ui ä¸º"console" åˆ™ä¸ºæ§åˆ¶å°ç¨‹åºå‘å¸ƒåè¿è¡Œæ—¶é»˜è®¤æ˜¾ç¤ºæ§åˆ¶å°çª—å£ã€‚

    project å…ƒç´ çš„å±æ€§ dstrip æŒ‡å®šæ˜¯å¦ç§»é™¤è°ƒè¯•ç¬¦å·ã€‚ 

        * `dstrip="true"` åˆ™å‘å¸ƒåç§»é™¤è°ƒè¯•ä¿¡æ¯ï¼Œç”Ÿæˆçš„æ–‡ä»¶æ›´å°ä½†é”™è¯¯ä¿¡æ¯ä¼šç¼ºå°‘è°ƒè¯•ä¿¡æ¯ï¼ˆä¾‹å¦‚æ–‡ä»¶åè¡Œå·ï¼‰ã€‚

- folder å…ƒç´ ä¸ºå·¥ç¨‹ä¸­çš„è™šæ‹Ÿç›®å½•

    å¦‚æœ folder  çš„å±æ€§ embed ä¸º "true" åˆ™è¯¥ç›®å½•å‘å¸ƒååµŒå…¥ EXE èµ„æºæ–‡ä»¶ï¼Œaardio ä¸­å¾ˆå¤šå‡½æ•°å’Œåº“éƒ½è‡ªåŠ¨æ”¯æŒè¿™ç§åµŒå…¥èµ„æºè€Œä¸éœ€è¦é¢å¤–ä¿®æ”¹ä»£ç ã€‚ä¾‹å¦‚å¯¹äº `string.load("/res/test.txt")`ï¼Œæ— è®ºå‚æ•°æŒ‡å®šçš„æ–‡ä»¶æ˜¯ä¸æ˜¯ EXE èµ„æºæ–‡ä»¶å‡½æ•°çš„è¿”å›å€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™æ˜¯ aardio çš„ä¸€ä¸ªä¸»è¦ç‰¹æ€§ã€‚

    å¦‚æœ folder å…ƒç´ çš„å±æ€§ local ä¸º "true" åˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæœ¬åœ°ç›®å½•ï¼ˆé€šå¸¸ä¹Ÿæ˜¯ Web  å‰ç«¯å·¥ç¨‹çš„å‘å¸ƒç›®å½•ï¼‰ï¼Œå‘å¸ƒä¸º EXE æ—¶å°†æ·»åŠ è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ã€‚è¿™ç§ç›®å½•åœ¨å·¥ç¨‹ä¸­ä¸æ˜¾ç¤ºå­çº§æ–‡ä»¶æˆ–ç›®å½•ï¼Œå³é”®èœå•çš„ã€åŒæ­¥æœ¬åœ°ç›®å½•ã€ä¹Ÿæ˜¯æ— æ•ˆçš„ã€‚ 

    å¦‚æœ folder å…ƒç´ çš„å±æ€§ ignored ä¸º "true" æ˜¯æŒ‡è¿™ä¸ªç›®å½•åœ¨å‘å¸ƒæ—¶è¢«å¿½ç•¥ï¼ˆignoredï¼‰ã€‚è¿™ç§ç›®å½•é€šå¸¸ç”¨æ¥æŒ‡å‘åŒ…å« Web å‰ç«¯å·¥ç¨‹æºç çš„ç›®å½•ï¼Œå·¥ç¨‹æœ¬èº«å…¶å®å¹¶ä¸éœ€è¦è¿™äº›å¤šä½™çš„ç›®å½•ï¼Œç”Ÿæˆ EXE æ—¶ä¹Ÿä¼šå¿½ç•¥è¿™ç§ç›®å½•ã€‚

- file å…ƒç´ åˆ™è¡¨ç¤ºæ·»åŠ åˆ°å·¥ç¨‹ä¸­çš„æ–‡ä»¶

    åœ¨å·¥ç¨‹æ ¹ç›®å½•ä¸‹åªèƒ½æœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºå¯åŠ¨æ–‡ä»¶, æ–‡ä»¶è·¯å¾„å¿…é¡»æ˜¯ `main.aardio` æˆ–ä»¥  `.main.aardio` ç»“æŸã€‚é™¤äº†å¯åŠ¨æ–‡ä»¶ï¼Œå·¥ç¨‹æ ¹ç›®å½•åªèƒ½åŒ…å« folder å…ƒç´ ã€‚

*****/
	
		project = ideEnv ++ project + desc + '\r\n\r\n';
	
		var codePath = ide.getActiveDocPath();
		if(#codePath && ..string.endsWith(codePath,".aardio",true) ){
			project = project + '**ç”¨æˆ·å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ–‡ä»¶ä¸º:** "'+codePath+'"\r\n'
		} 
	
		wb.system(project);
	
	}
}

resetMessages();

if(_ASK_AI_SYSTEMP_PROMPT){
	wb.system(_ASK_AI_SYSTEMP_PROMPT);
}

if(_ASK_AI_USER_PROMPT){
	winform.editPrompt.text = _ASK_AI_USER_PROMPT;
}

winform.btnClear.oncommand = function(id,event){
	resetMessages();//æ¸…é™¤èŠå¤©ä¸Šä¸‹æ–‡
	winform.editPrompt.setFocus();
}

winform.splitter.origTop = winform.splitter.top;

import thread.event;
var eventStop = thread.event();

//å“åº”æŒ‰é”®äº‹ä»¶ï¼Œè¾“å…¥ç”¨æˆ·æç¤ºè¯
winform.btnSend.oncommand = function(id,event){
	
	if(winform.btnSend.text == "åœæ­¢"){
		eventStop.set();
		
		winform.btnSend.disabledText = {'\uF254';'\uF251';'\uF252';'\uF253';'\uF250'}
		return;
	}
	
	var prompt = winform.editPrompt.text;
	if(!#prompt){
		wb.errorMessage("è¯·å…ˆè¾“å…¥é—®é¢˜ã€‚")
		winform.editPrompt.setFocus();
		return;
	}
	
	var tApiUrl = inet.url.split(aiChatConfig.url);
	if(!tApiUrl){
		wb.errorMessage(`é”™è¯¯çš„æ¥å£ç½‘å€ï¼Œ;<a href="javascript:void(0)" onclick="javascript:external.updateApiKey()">ç‚¹è¿™é‡Œé‡æ–°è®¾ç½®</a>`)
		winform.editPrompt.setFocus();
		return;
	}
	
	winform.btnSend.disabledText = {'\uF254';'\uF251';'\uF252';'\uF253';'\uF250'}
	
	winform.btnClear.disabled = true; 
	winform.btnSnap.disabled = true;
	winform.chkFix.disabled = true;

	wb.chatMessage.limit = aiChatConfig.msgLimit; 
	
	var assistantMsg = wb.lastAssistantMessage();
	if(assistantMsg && winform.chkFix.checked){
		//Few-shot Learning
		assistantMsg.content = ide.aifix.markdown(assistantMsg.content,true);
	}
	
	//è¾“å…¥ AI æç¤ºè¯
	wb.prompt( prompt );
	winform.editPrompt.text = "";

	if(string.indexOf(prompt,`"""é€‰ä¸­ä»£ç """`)){
	
	} 
	elseif(wb.aiSearched 
		|| (aiChatConfig.model && ( ..string.endsWith(aiChatConfig.model,":online") ||  ..string.startsWith(aiChatConfig.model,"aardio") ) ) 
	){
	
	}
	elseif( (config.search[["mode"]]=="exa" && config.search.exa )
		||(config.search[["mode"]]=="tavily" && config.search.tavily ) ){
			
		wb.showLoading("æ­£åœ¨è”ç½‘æœç´¢");
		
		import web.turndown; 
		var ok = thread.invokeAndWait( function(wb,prompt,searchConfig){
				import web.rest.jsonClient;;
				
				if(searchConfig.mode=="exa"){
					//å¯¼å…¥ Exa ç´¢æ¥å£ 
					var exaClient = web.rest.jsonClient(); 
					exaClient.setHeaders({ "x-api-key": searchConfig.exa.key} )
					var exa = exaClient.api("https://api.exa.ai/");
					
					//æœç´¢
					var searchData,err = exa.search({
    					query:"aardio ç¼–ç¨‹è¯­è¨€æ–‡æ¡£ èŒƒä¾‹ " + prompt,
    					contents={text= true},
    					numResults: searchConfig.exa.count || 2, 
    					includeDomains: searchConfig.exa.includeDomains,
    					excludeDomains: !searchConfig.exa.includeDomains ? searchConfig.exa.excludeDomains : null,
    					type:"keyword" //ä¸€èˆ¬ keyword æœç´¢å°±å¤Ÿäº†ï¼ˆä»·æ ¼ä½ä¸€äº›ï¼‰
					}) 
					
					var ret  = searchData[["results"]]
					if(ret){
						wb.url(ret);	
						return true;
					}
					elseif(err){
						wb.errorMessage(err); 
					}		
				}
				elseif(searchConfig.mode=="tavily"){
					var http = web.rest.jsonClient();  
					http.setAuthToken(searchConfig.tavily.key); 
					var tavily = http.api("https://api.tavily.com");
  	
					//æœç´¢
					var searchData,err = tavily.search({ 
    					query = "aardio ç¼–ç¨‹è¯­è¨€æ–‡æ¡£ èŒƒä¾‹ "  + prompt,
    					includeDomains = searchConfig.exa.includeDomains,
    					excludeDomains: !searchConfig.exa.includeDomains ? searchConfig.exa.excludeDomains : null,
    					max_results =  searchConfig.exa.count || 2 //è¿”å›çš„æœç´¢ç»“æœæ•°é‡ï¼Œä¸å¿…è¦å¤ªå¤šï¼Œå‰ä¸¤ä¸‰æ¡å°±å¯ä»¥äº†
					})
					
					//å°†æœç´¢ç»“æœæ·»åŠ åˆ°ç³»ç»Ÿæç¤ºè¯
					var ret = searchData[["results"]]
					if(ret){
						wb.url(ret);	
						return true;
					}
					elseif(err){
						wb.errorMessage(err);
					}	
				} 		
			},wb,prompt,config.search) 
			
			if(!ok){
				
				winform.btnSend.disabledText = null;
				winform.btnClear.disabled = false; 
				winform.btnSnap.disabled = false;
				winform.chkFix.disabled = false;
				
				return;
			}
			
			wb.aiSearched = true;
			wb.showLoading("æ­£åœ¨æ€è€ƒ")
	}
	
    var knowledge = ""

	if(!string.find(prompt,"<```>|<import>|<web\.view>|<inet\.http>|<web\.rest>")){
		
		prompt = string.replace(prompt,"![""'`\w]https?\://[^\s\)""']+",
			function(url){
				
				if(!..string.match(url,"<@@.js@>|<@@.css@>|<@@.jpg@>|<@@.png@>|<@@.gif@>|<@@.webp@>$") ){
					wb.showLoading("æ­£åœ¨è¯»å–ï¼š"+url)
		
					import web.turndown;
					var md,err = web.turndown.httpGet(url) 
					if(!#md) return;
					
					md = '\r\n\r\nç”¨æˆ·è¾“å…¥çš„å‚è€ƒç½‘å€ï¼š' + url 
						+  '\r\n\r\nä¸‹é¢æ˜¯è‡ªè¯¥ç½‘å€è·å–çš„' +(err?" Markdown ":"æ–‡æœ¬")+'æ ¼å¼å†…å®¹ï¼š'
						+  '\r\n\r\n' + md +'\r\n\r\n------------------------\r\n\r\n'
		 		
					knowledge = knowledge ++ md;
				}
	
			});		
	}

	if(#knowledge){
		wb.system(knowledge)
		
		if(string.match(prompt,`^\s*(https?\://[^\s()"']+)\s*$`)){
			prompt = "è§£è¯»åˆ†æä¸æ€»ç»“è¦ç‚¹ " + prompt; 
		}
	} 

	aiChatConfig.maxTokens = winform.spinMaxTokens.pos;
	
	winform.splitter.splitAt(winform.splitter.origTop);
	
	eventStop.reset();
	
	var loading = {'\uF254';'\uF251';'\uF252';'\uF253';'\uF250' }
	winform.btnSend.disabledText = null;
	winform.btnSend.text = "åœæ­¢" 
	winform.btnSend.reduce(loading,function(value,index){
		if(value) winform.btnSend.iconText = value;
		return 150;
	} )

	//åˆ›å»ºå¤šçº¿ç¨‹å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚
	thread.invoke( 
		function(wb,aiChatConfig,eventStop){
			for(k,v in aiChatConfig){ 
				if(v==="")aiChatConfig[k] = null;
			} 
			
			if(!#aiChatConfig.key){
				aiChatConfig = table.assign(aiChatConfig,{  
					url = "https://ai.aardio.com/api/v1/";
					model = "aardio";
					temperature = 0.1;
				});	
			} 
			
			//å¯¼å…¥è°ƒç”¨ HTTP æ¥å£çš„ REST å®¢æˆ·ç«¯
			import web.rest.aiChat;
			aiChatConfig.userAgent = "Mozilla/5.0 (Windows NT "+ _WIN_VER_MAJOR +"."+_WIN_VER_MINOR+"; aardio; rv:"+_AARDIO_VERSION+") like Gecko";
			
			var client = web.rest.aiChat(aiChatConfig);
			client.referer = "https://aardio.com";
			client.setHeaders({ "X-Title":"aardio"});
   
			var ok,err = client.messages(wb.chatMessage,function(deltaText,deltaReasoning){
				if(eventStop.wait(0)){
					return  false; 
				}
				
				if(#deltaReasoning){
					wb.showThinking(deltaReasoning);
					return;
				}
				
				wb.assistant(deltaText);
			} );
 
					
			if(err){
				//è·å–é”™è¯¯å¯¹è±¡ï¼ˆè§£æ JSON æ ¼å¼çš„é”™è¯¯ä¿¡æ¯ï¼‰
				var errObject = client.lastResponseError()
				if(errObject[["error"]][["type"]] == "authentication_error" ){
					wb.errorMessage(`API å¯†é’¥é”™è¯¯ï¼<a href="https://aardio.com/vip/">ç‚¹è¿™é‡Œè·å–å¯†é’¥</a>ï¼Œ&nbsp;<a href="javascript:void(0)" onclick="javascript:external.updateApiKey()">ç‚¹è¿™é‡Œè®¾ç½®æ–°å¯†é’¥</a>`)
				}
				else {
					wb.errorMessage(err)
				}
			}  
			elseif(!ok){
				wb.errorMessage("é”™è¯¯ä»£ç ï¼š" + ( client.lastStatusCode : "æœªçŸ¥ " + (client.lastResponseString() || "")))
			}
			elseif(aiChatConfig.usage){
				var last = client.lastResponseObject()
			 
				if(last){
					 
					var out = "" 
					var usage = last.usage || last["usageMetadata"] || last["amazon-bedrock-invocationMetrics"]
					
					if(usage){
						var cTokens,pTokens,cacheTokens;
						
						if( (client._protocol=="vertex") || (client._protocol=="google") ){ 
							pTokens = usage.promptTokenCount; 
							cTokens = usage.totalTokenCount:0 - pTokens:0;
						}
						elseif(client._protocol=="aliyun"){
							usage = usage[["models"]][[1]];
							cTokens = usage.output_tokens
							pTokens = usage.input_tokens;
						}
						else {
							cTokens = usage.completion_tokens || usage["outputTokenCount"]
							pTokens = usage.prompt_tokens || usage.inputTokenCount || usage.input_tokens;
							cacheTokens = usage.prompt_cache_hit_tokens
						}
						
						var unitNames = { 
    						[1000000000]="G";[1000000]="M";[1000]="K";[1]="";
						} 
						
						import fsys.size;
						var formatSize = function(tokens){
							var size,unit = fsys.size.format(tokens);
							return size ++ unitNames[unit]
						}
					  
						if(cTokens){
							out = out + 'å›å¤ tokens:<code>' + formatSize(cTokens) + "</code> "
						}
						 
						if(pTokens){
							out = out + 'æç¤º tokens:<code>' + formatSize(pTokens) + "</code> "
						}
						
						if(cacheTokens){
							out = out + 'ç¼“å­˜ tokens:<code>' + formatSize(cacheTokens) + "</code> "
						} 
					}
					
					if(last.error){
						wb.errorMessage( last.error[["message"]] || ..JSON.stringify(last.error,true,false) ) 
					}
					else {
						wb.errorMessage(#out ? out : "æ¨¡å‹æœªæä¾› token ç”¨é‡")
					}  
				}
				else { 
					wb.errorMessage("æ¨¡å‹æœªæä¾› token ç”¨é‡")
				} 
			}
			
			if(ok){
				
				//åœ¨ AI å¯¹è¯å°¾éƒ¨å¢åŠ å¤åˆ¶ &#xF0C5;  ä¸å–œæ¬¢ &#xF088; å–œæ¬¢ &#xF164; çš„åé¦ˆæŒ‰é’®
				wb.insertAdjacentHTML("beforeEnd", `
	<div style="color: #999">
<span style="cursor:pointer" title="å¤åˆ¶ä»£ç " onclick="external.copyCode()"><span style="font-family: 'FontAwesome';font-size: 16px;">&#xF0C5;</span> å¤åˆ¶ä»£ç </span>
&nbsp;&nbsp;<span style="cursor:pointer" title="å–œæ¬¢" onclick="external.like()"><span style="font-family: 'FontAwesome';font-size: 16px;">&#xF164;</span> æ»¡æ„</span>
&nbsp;&nbsp;<span style="cursor:pointer" title="åé¦ˆæ­¤å¯¹è¯åˆ° VIP ä¸“å±æœåŠ¡é‚®ç®±" onclick="external.dislike()"><span style="font-family: 'FontAwesome';font-size: 16px;">&#xF165;</span> è½¬äººå·¥</span>
	</div>
	`)
			}
			 
		},wb,aiChatConfig,eventStop//å°†å‚æ•°ä¼ å…¥çº¿ç¨‹
	)
	
	winform.btnCopy.disabled = false;
}

//åœ¨ AI å›å¤ç»“æŸåå›è°ƒæ­¤å‡½æ•°
wb.onWriteEnd = function(){
	winform.btnSend.disabledText = null;
	winform.btnSend.reduce(false);
	
	winform.btnSend.text = "é—® AI";
	winform.btnSend.iconText = '\uF0AA';
	
	winform.btnClear.disabled = false;
	winform.btnCopy.disabled = false;
	winform.btnSnap.disabled = false;
	winform.chkFix.disabled = false;
	winform.editPrompt.setFocus();
}

//åœ¨ AI å›å¤ç»“æŸä»¥å‰å›è°ƒæ­¤å‡½æ•°ï¼Œè‡ªåŠ¨ä¿®æ­£ aardio ä»£ç å—ä¸­çš„å¸¸è§å¹»è§‰é”™è¯¯
import ide.aifix;
wb.beforerWriteEnd = function(markdown){
	if(winform.chkFix.checked) { 
		return ide.aifix.markdown(markdown,true);
	}
	
	return markdown;
}

//å¯¼å‡º aardio å‡½æ•°åˆ°ç½‘é¡µ JavaScript ä¸­ã€‚
wb.external = {
	updateApiKey = function(){
		winform.btnSetting.oncommand();
	} 
	copyCode = function(){
		
		var md = wb.lastMarkdown();
		if(!#md) return winform.msgboxErr("æ¶ˆæ¯ä¸ºç©ºã€‚");
	
		var found;
		for indent,_,code in string.gmatch(md,"!\N([ \t]*)(```+)<aardio>(.+?)!\N\s*\2![^`\S]") { 
			
			if(#indent){ 
				text = string.replace(text,"\n+"+indent,'\n');
			}	
		
			if(winform.chkFix.checked) code = ide.aifix(code,true);
		    win.clip.write( code );
		    found = true;
		}
		
		if(!found){
			return winform.msgboxErr("æ²¡æœ‰æ‰¾åˆ°ä»£ç å—ã€‚");	
		} 	
		else{
			winform.msgbox("å·²å¤åˆ¶æœ€åä¸€ä¸ªä»£ç æ®µåˆ°å‰ªè´´æ¿ã€‚
			
æ‚¨å¯ä»¥ç‚¹çª—å£åº•éƒ¨çš„ã€Œå¤åˆ¶ã€æŒ‰é’®å¤åˆ¶å…¨éƒ¨ Markdown æ ¼å¼æ–‡æœ¬ï¼Œ
ç„¶åé€šè¿‡ aardio ä»£ç ç¼–è¾‘å™¨å³é”®èœå•çš„ã€Œç²˜è´´ä¸æ›´æ­£ã€æå–å¹¶åˆå¹¶å¤šä¸ªä»£ç æ®µã€‚")
		}
			
	}
	like = function(){
		if(inet.url.split(aiChatConfig.url).host!="ai.aardio.com"){
			winform.msgboxErr("ä»… VIP ä¸“å±æ¥å£å¯ç”¨ï¼")
			return;
		}
		
		import web.rest.jsonLiteClient;
		var http = web.rest.jsonLiteClient();
		http.setAuthToken(aiChatConfig.key);
		
		var resp = http.post( "https://ai.aardio.com/api/v1/report/",{
			message = JSON.stringify(wb.chatMessage);
			like = true;
		})
			
		winform.msgbox( resp[["message"]] || "æäº¤å¤±è´¥");	
	}
	dislike = function(){
	 
		if(inet.url.split(aiChatConfig.url).host!="ai.aardio.com"){
			winform.msgboxErr("ä»… VIP ä¸“å±æ¥å£å¯ç”¨ï¼")
			return;
		}
		
		import web.rest.jsonLiteClient;
		var http = web.rest.jsonLiteClient();
		http.setAuthToken(aiChatConfig.key);
		
		var resp = http.post( "https://ai.aardio.com/api/v1/report/",{
			message = JSON.stringify(wb.chatMessage);
			like = false;
		})
			
		winform.msgbox( resp[["message"]] || "æäº¤å¤±è´¥");
	} 
}

import key;
import win.clip;
winform.btnCopy.oncommand = function(id,event){
	var md = wb.lastMarkdown();
	if(!#md) return winform.msgboxErr("æ¶ˆæ¯ä¸ºç©ºã€‚");
	
	if(key.getState("CTRL")){
		
		var found;
		for indent,_,code in string.gmatch(md,"!\N([ \t]*)(```+)<aardio>(.+?)!\N\s*\2![^`\S]") { 
			
			if(#indent){ 
				text = string.replace(text,"\n+"+indent,'\n');
			}	
		
			if(winform.chkFix.checked) code = ide.aifix(code,true);
		    win.clip.write( code );
		    found = true;
		}
		
		if(!found){
			return winform.msgboxErr("æ²¡æœ‰æ‰¾åˆ°ä»£ç å—ã€‚");	
		} 
	}
	else{
		if(winform.chkFix.checked) md = ide.aifix.markdown(md,true);
		win.clip.write( md )
	}
	
	winform.btnCopy.disabledText = {'\uF254';'\uF251';'\uF252';'\uF253';'\uF250';text=''} 
	thread.delay(800);
	winform.btnCopy.disabledText = null;
	
	winform.editPrompt.setFocus();
}

//è®¾ç½®æ¥å£åœ°å€ä¸ API ä»¤ç‰Œçš„çª—å£
winform.btnSetting.oncommand = function(id,event){
	var frmSetting = winform.loadForm("/aardioAgent/setting.aardio")
	
	if(wb.documentMode<11){
		frmSetting.chkKatex.checked = false;
		frmSetting.chkKatex.disabled = true;
	}
	
	if( frmSetting.doModal(winform) ){
		var configItem = config.selItem ? config.itemData[config.selItem] 
		if(configItem){
			table.assign(aiChatConfig,configItem); 
			
			winform.cmbAgent.items = config.itemNames;
			winform.cmbAgent.selIndex = config.selItem; 
			
			if(!wb.started()){
 				if( !string.find(winform.editPrompt.text,`"""é€‰ä¸­ä»£ç """`) ){
 					resetMessages();
 				} 
 			} 
		} 
	}
	
	winform.editPrompt.setFocus();
}

winform.chkFix.checked = true;
winform.chkFix.oncommand = function(id,event){
	var md = wb.getMarkdown();
	if(owner.checked){
		md = ide.aifix.markdown(md,true)
	}
	
	wb.write(md);
	
	winform.editPrompt.setFocus();
}

var tip = /*
- åœ¨ä»£ç ç¼–è¾‘å™¨æŒ‰ `F1` é”®å¯è°ƒç”¨`å½“å‰ç¼–ç åŠ©æ‰‹`å¸®æ‚¨ç»­å†™æˆ–è¡¥å…¨ä»£ç ï¼ˆå¦‚æœ‰é€‰åŒºåˆ™æ‰“å¼€æ–‡æ¡£ï¼‰ã€‚
	* å»ºè®®åœ¨è¾“å…¥å…‰æ ‡å‰ç”¨`è¡Œæ³¨é‡Š`è¯´æ˜éœ€æ±‚ï¼Œå†æŒ‰ `F1` é”®ã€‚ 
	* è¿è¡ŒæŠ¥é”™å 30 ç§’å†…åœ¨ä»£ç ç¼–è¾‘å™¨æŒ‰ F1 ï¼Œæ— é€‰åŒºåˆ™è°ƒç”¨ AI çº é”™ã€‚
	* ä½¿ç”¨ç¬¬ä¸‰æ–¹å¯†é’¥å› æ— æ³•æ¥å…¥ä¸“ä¸šç‰ˆ aardio çŸ¥è¯†åº“ï¼Œç”Ÿæˆçš„å›å¤ä¸ä»£ç è´¨é‡ä¼šä¸¥é‡ä¸‹é™ã€‚
	* <a href="https://aardio.com/vip/">âœ¨ ç‚¹æ­¤è´­ä¹°ä¸“ä¸šç‰ˆå¯†é’¥ï¼ˆAPI Keyï¼‰</a>&nbsp;<a href="javascript:void(0)" onclick="javascript:external.updateApiKey()">âš’ è®¾ç½®æ–°å¯†é’¥</a>&nbsp;<a href="https://aardio.com/vip/find-key/">ğŸ’¡ æ‰¾å›å¯†é’¥</a>
- èŠå¤©ç•Œé¢å¯è”ç½‘è¯»å–æç¤ºè¯å†…çš„ç½‘é¡µé“¾æ¥ï¼Œå¹¶è‡ªåŠ¨è½¬æ¢ä¸º Markdown æ ¼å¼æ–‡æœ¬ã€‚
- æŒ‰ä½ `Ctrl` é”®ç‚¹ä¸‹é¢çš„ `å¤åˆ¶` æŒ‰é’®å¯å¤åˆ¶ AI æœ€åä¸€æ¬¡è¾“å‡ºçš„ä»£ç å—ã€‚
- æŒ‰ä½ `Ctrl` é”®ç‚¹ä¸‹é¢çš„ <image src="data:image/x-png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAiCAYAAAAkjjtxAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAHYcAAB2HAY/l8WUAAAFzSURBVFhH7ZY9roQwDIT3wpyFK3ABempKSi5ARUVDRUHDagpLfnYICcTWPomRRlptQvLJP0k+xz/TR/7x63qBrXULeNu2Y1mWqDHHQtnAwzAcVVUleZom+fljZQHP86ygrlw60lnAXdcpoCsjIyV1Cox0juP4xxImxXVdq3WelIoC3vf9aJpGbVzabdvKrZOkgPu+V4tbGdHOlQKWi1r6TpQfASMbODno7MXvnAy5AaPGY8fVuq7qm5BdgAGLxiQhqtT9ACWlQLsAI/UQoLGhHEdJkHB8yXFuc2BElxSrVd79cozbHJhAUL9yTJoUux3dgFEWckyaFLsh3YBTGooUKx1zYKSXFLu+eePF5pkDw3T+nkWZH3tXpeMCzKMMeEQTG8MoGYJNeUS5AMM85SGlwMJuwDCAcMtxARSXBd7Acn7IrsDcAEyF5C4CHLpurXxVWiEp4LPutzB/RKVKAUOA5t1f2lj7DiwUBP5lvcDWeoGt9QXF/vNj8+wS+wAAAABJRU5ErkJggg==" height="24"  style="display: inline-block; vertical-align: top;"> æŒ‰é’®å¯æˆªé•¿å±åˆ°å‰ªè´´æ¿ã€‚ 
- æŒ‰ä½ `Ctrl+Enter` å¯ç›´æ¥å‘é€é—®é¢˜ ã€‚ã€‚
*/

wb.write(tip)

//é»˜è®¤è®¾ç½®è¾“å…¥æ¡†ç„¦ç‚¹
winform.editPrompt.setFocus();

winform.splitter.ltMin = 200;
winform.splitter.rbMin = 150;

var scrollbarHeight = ::User32.GetSystemMetrics(3/*_SM_CYHSCROLL*/)
winform.editPrompt.onOk = function(ctrl,alt,shift){ 
	if(ctrl){
		winform.btnSend.oncommand();
		return true; 
	} 
	
	var pt = ::POINT()
	::User32.GetCaretPos(pt) 
	
	var lineCount = winform.editPrompt.lineCount;
	var lineHeight = math.ceil(pt.x / lineCount + winform.dpiScale(5)); 
	  
	if(pt.y+(lineHeight+scrollbarHeight)*3>winform.editPrompt.height){  
 
		winform.wndBrowser.setRedraw(false)
		winform.splitter.splitMove(-lineHeight) 
		winform.wndBrowser.setRedraw(true) 
	}
}

//æ‹†åˆ†ç•Œé¢
winform.splitter.split(winform.wndBrowser,{winform.bkPrompt,winform.editPrompt});

winform.editPrompt.enablePopMenu(function(){
	return { 
		
		{ 'é—® AIï¼ˆå‘é€ï¼‰\tCtrl+Enter';  function(id){
			winform.btnSend.oncommand();
		}; 0};  
		
		{ /*åˆ†éš”çº¿*/ };
		{ (wb.aiSystemPropmptStringPatterns?"å·²è‡ªåŠ¨":"")+"æ’å…¥ æ¨¡å¼åŒ¹é…è¯­æ³•æ–‡æ¡£";  function(id){
			winform.editPrompt.selText = " [aardio æ¨¡å¼åŒ¹é…è¯­æ³•](https://www.aardio.com/zh-cn/doc/library-guide/builtin/string/patterns.html.md) "
		}; wb.aiSystemPropmptStringPatterns?1/*_MF_GRAYED*/: 0};
		{ (wb.aiSystemPropmptWebView?"å·²è‡ªåŠ¨":"")+"æ’å…¥ web.view æŒ‡å—ï¼ˆç½‘é¡µç›¸å…³ï¼‰";  function(id){
			winform.editPrompt.selText = " [web.view ä½¿ç”¨æŒ‡å—](https://www.aardio.com/zh-cn/doc/library-guide/std/web/view/_.html.md) "
		}; wb.aiSystemPropmptWebView?1/*_MF_GRAYED*/: 0};
		{ "æ’å…¥ web.rest æŒ‡å—ï¼ˆHTTP ç›¸å…³ï¼‰";  function(id){
			winform.editPrompt.selText = " [web.rest ä½¿ç”¨æŒ‡å—](https://www.aardio.com/zh-cn/doc/library-guide/std/web/rest/client.html.md) "
		}; 0};
		{ "æ’å…¥ å¤šçº¿ç¨‹å…¥é—¨";  function(id){
			winform.editPrompt.selText = " [å¤šçº¿ç¨‹å¼€å‘å…¥é—¨](https://www.aardio.com/zh-cn/doc/guide/language/thread.html.md) "
		}; 0};  
		{ "æ’å…¥ é«˜çº§é€‰é¡¹å¡æŒ‡å—ï¼ˆå¤šçª—å£ï¼‰";  function(id){
			winform.editPrompt.selText = " [é«˜çº§é€‰é¡¹å¡æŒ‡å—](https://www.aardio.com/zh-cn/doc/library-guide/std/win/ui/tabs/_.html.md) "
		}; 0};  
		{ (wb.aiSystemPropmptPlus?"å·²è‡ªåŠ¨":"")+"æ’å…¥ plus æ§ä»¶æŒ‡å—ï¼ˆç•Œé¢ç¾åŒ–ï¼‰";  function(id){
			winform.editPrompt.selText = " [plus æ§ä»¶ä½¿ç”¨æŒ‡å—](https://www.aardio.com/zh-cn/doc/library-guide/std/win/ui/ctrl/plus.html.md) "
		}; wb.aiSystemPropmptPlus?1/*_MF_GRAYED*/: 0}; 
		{ "æ’å…¥ è‡ªå®šä¹‰æ§ä»¶æŒ‡å—";  function(id){
			winform.editPrompt.selText = " [è‡ªå®šä¹‰æ§ä»¶ä½¿ç”¨æŒ‡å—](https://www.aardio.com/zh-cn/doc/library-guide/std/win/ui/ctrl/custom.html.md) "
		}; 0};  
		{ (wb.aiSystemPropmptPython?"å·²è‡ªåŠ¨":"")+"æ’å…¥ è°ƒç”¨ Python æ–‡æ¡£";  function(id){
			winform.editPrompt.selText = " [aardio è°ƒç”¨ Python å…¥é—¨æŒ‡å—](https://www.aardio.com/zh-cn/doc/library-guide/ext/python/_.html.md) "
		}; wb.aiSystemPropmptPython?1/*_MF_GRAYED*/: 0};
		{ (wb.aiSystemPropmptNet?"å·²è‡ªåŠ¨":"")+"æ’å…¥ è°ƒç”¨ NET æ–‡æ¡£";  function(id){
			winform.editPrompt.selText = " [aardio è°ƒç”¨ .NET å…¥é—¨æŒ‡å—](https://www.aardio.com/zh-cn/doc/library-guide/std/dotNet/_.html.md) "
		}; wb.aiSystemPropmptNet?1/*_MF_GRAYED*/: 0};
		{ (wb.aiSystemPropmptSupperHotkeys?"å·²è‡ªåŠ¨":"")+"æ’å…¥ è¶…çº§çƒ­é”®æ–‡æ¡£";  function(id){
			winform.editPrompt.selText = " [è¶…çº§çƒ­é”®ä½¿ç”¨æŒ‡å—](https://www.aardio.com/zh-cn/doc/library-guide/std/key/hotkey.html.md) "
		}; wb.aiSystemPropmptSupperHotkeys?1/*_MF_GRAYED*/: 0};  
		{ "æ’å…¥åŸç”Ÿæ¥å£æ–‡æ¡£ï¼ˆè°ƒç”¨ DLLï¼‰";  function(id){
			winform.editPrompt.selText = " [åŸç”Ÿç±»å‹](https://www.aardio.com/zh-cn/doc/library-guide/builtin/raw/datatype.html.md)  [ç»“æ„ä½“](https://www.aardio.com/zh-cn/doc/library-guide/builtin/raw/struct.html.md)  [å£°æ˜åŸç”Ÿ API](https://www.aardio.com/zh-cn/doc/library-guide/builtin/raw/api.html.md)  [åŸç”Ÿå›è°ƒå‡½æ•°](https://www.aardio.com/zh-cn/doc/library-guide/builtin/raw/callback.html.md) "
		}; 0}; 
		{ "å¿«é€Ÿæ£€ç´¢ç›¸å…³æ–‡æ¡£";  function(id){
			var q = winform.editPrompt.selText;
			if(!#q) q = winform.editPrompt.text;
			
			if(#q){
				import inet.url;
				raw.execute("https://www.aardio.com/zh-cn/doc/?q="+inet.url.encode(q));
			}
		}; #owner.text==0 ? 1/*_MF_GRAYED*/ : 0}; 	
		{ /*åˆ†éš”çº¿*/ };
		
		{ 'å¯¼å…¥å¯¹è¯';  function(id){
			import fsys.dlg;
			var path = fsys.dlg.open("*.jsonl|*.jsonl|*.json|*.json||","è‡ª jsonl æˆ– json æ–‡ä»¶å¯¼å…¥å¯¹è¯");
			if(!path) return;
			
			wb.importChatMessages(path);
		}; winform.btnSend.text == "åœæ­¢" ? 1/*_MF_GRAYED*/ : 0}; 
		
		{ "å¯¼å‡ºå¯¹è¯";  function(id){
			import fsys.dlg;
			var path = fsys.dlg.save("*.jsonl|*.jsonl|*.json|*.json||","å¯¼å‡ºå¯¹è¯åˆ° *.jsonl");
			if(!path) return;
			
			var file,err = io.file(path,"w+b");
			if(!file) return winform.msgboxErr(err);
			 
			var chatMessage = wb.chatMessage;
			
			if(..string.endWith(path,".jsonl",true)){
				for(i=1;#chatMessage;1){
					var msg = chatMessage[i]
					var line  = JSON.stringify(msg,false,false);
					line = string.crlf(line,"")
					file.write(line,'\r\n');
				}
			}
			else {
				file.write((JSON.stringifyArray(chatMessage,true,false)));
			}
			
			file.close();
			
		}; #wb.chatMessage<3 ? 1/*_MF_GRAYED*/ : 0}; 
		 
		
		{ "ç¼–è¾‘å¯¹è¯";  function(id){
		   
			ide.createProcess("~\example\WebUI\web.view\OtherApps\json-editor.aardio",{
				_JSON_EDITOR_TEXT = JSON.stringifyArray(wb.chatMessage,true,false);
			});
			
		}; #wb.chatMessage<3 ? 1/*_MF_GRAYED*/ : 0}; 
		
		{ /*åˆ†éš”çº¿*/ };
		
		(win.getStyleEx(winform.hwnd, 8/*_WS_EX_TOPMOST*/) & 8)
		? ( { 'å–æ¶ˆç½®é¡¶';  function(id){
			win.setTopmost(winform.hwnd,false)
		} } ) 
		: ( { 'ç½®é¡¶çª—å£';  function(id){
			win.setTopmost(winform.hwnd)
		} } )
	}
})

wb.BeforeNavigate2 = function( pDisp, url, flags, targetFrame, postData, headers, cancel ) { 
 
    if(..string.match(url,"\.<@@jsonl@>|<@@json@>$") && io.exist(url) ){ 
        winform.setTimeout( 
        	function(){
        		wb.importChatMessages(url)
        	}
        );	
    } 
    else {
        
   		if(url[1]=='a'# && ..string.startsWith(url,"about:") ){ 
				url = ..string.replace(url,"^about\:<<\.\./>+>|/(<language\-reference/>|<library\-guide/>|<language\-reference/>|<guide/>)"
        			,"https://www.aardio.com/zh-cn/doc/\1"); 
    	}
        
		url = ..string.replace(url,"^(<@https://www.aardio.com/zh-cn/doc/library-guide/std/@>)(.+)$"
    		,function(dir,path){
        		path = ..string.replace(path,"\.html$",".md"); 
        		
        		var fullpath = io.joinpath("~/doc/library-guide/std",path);
        		if(!..io.exist(fullpath)){
        			return "https://www.aardio.com/zh-cn/doc/library-reference/"+path
        		}
    		} 
		);  
 		
		url = ..string.replace(url,"\.md$",".html"); 
		
		url = string.replace(url,"^<@https://www.aardio.com/zh-cn/doc/library-reference/@>(.+?)</_>?\.html$"
			,function(libPath){
				libPath = ..string.replace(libPath,"/",".");
				libPath = ..string.replace(libPath,"\.\.","."); 
				var libPath2 = ..io.libpath(libPath) 
				if(!libPath2){
					return "https://www.aardio.com/zh-cn/doc/?q="+libPath;
				}
				
				libPath2 = ..fsys.path.relative(libPath2,"~/lib",false); 
				libPath2 = ..string.replace(libPath2,"\.aardio$","");
				libPath2 = ..string.replace(libPath2,"\\","/");
				
				return "https://www.aardio.com/zh-cn/doc/library-reference/"+libPath2+".html";
			}
		)
		
    	..raw.execute(url);
    }
    
    return url, flags, targetFrame, postData, headers, true;
} 

winform.onDropFiles = function(files){
	var path = files[1];
	if(..string.match(path,"\.<@@jsonl@>|<@@json@>$")){
		wb.importChatMessages(path);
	}
}

wb.importChatMessages = function(path){
	var json = string.load(path);
	if(!#json){
		return winform.msgboxErr("æ— æ•ˆå¯¹è¯æ•°æ®")
	}
	
	var messages;
	
	if(..string.endsWith(path,".jsonl",true)){
		messages = JSON.ndParse(json);
	}
	else {
		messages = JSON.parse(json);
	}
	
	
	if(!#messages){
		return winform.msgboxErr("æ— æ•ˆå¯¹è¯æ•°æ®")
	}
			
	wb.clear();  
	wb.aiSearched = null;
	
	for(i=1;#messages;1){
		var msg = messages[i];
		
		if(type(msg.content)!="string"){
			 
			if(msg[["role"]]=="assistant"){
				var f = msg[["tool_calls"]][[1]][["function"]];
				if(f[["name"]] && f[["arguments"]]){
					wb.assistant("æ­£åœ¨è°ƒç”¨å·¥å…· "+f.name+ 'ï¼Œå‚æ•°ï¼š\r\n\r\n```javascript\r\n'
					+ f.arguments + '\r\n```\r\n\r\n') 
					continue;
				}
				
			}
			
			if(msg[["role"]]!="user"){
				resetMessages();
				return winform.msgboxErr("å¯¹è¯æ•°æ®æ ¼å¼é”™è¯¯ï¼Œrole å­—æ®µçš„å€¼ä¸æ˜¯ user åˆ™ content å­—æ®µå¿…é¡»æ˜¯å­—ç¬¦ä¸²ï¼")
			}
			elseif(!..table.isArrayLike(msg.content)){
				return winform.msgboxErr("å¯¹è¯æ•°æ®æ ¼å¼é”™è¯¯ï¼Œcontent å­—æ®µåªèƒ½æ˜¯å­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼")
			}
		}
		
		if(msg[["role"]]=="system"){
			wb.system(msg.content)
		}
		elseif(msg[["role"]]=="user"){
			wb.prompt(msg.content)
		}
		elseif(msg[["role"]]=="assistant"){
			
			var content = msg.content || "";
			if(winform.chkFix.checked){
				content = ide.aifix.markdown(content,true);
			}
			wb.assistant(content)
			wb.assistant(null)
		}
		else {
			//resetMessages();
			//return winform.msgboxErr("å¯¹è¯æ•°æ®æ ¼å¼é”™è¯¯ï¼Œrole å­—æ®µå¿…é¡»æ˜¯ system,user,assistant ä¹‹ä¸€ã€‚")
		} 
	} 	
}

global.onError = function( err,over ){ 
    if(!over){
        import debug;
        var stack = debug.traceback(,"è°ƒç”¨æ ˆ",3);
        err = string.concat(err,stack);
    }
    
    if( _STUDIO_INVOKED ) {
    	import win;
    	win.msgboxErr(err);
    }
}

winform.spinMaxTokens.buddy = winform.editMaxTokens;
winform.spinMaxTokens.setRange(1,1024*16);
winform.spinMaxTokens.pos = aiChatConfig.maxTokens || 2048;
winform.spinMaxTokens.inc = 1024;

winform.beforeDestroy = function(){
    config.maxTokens = winform.spinMaxTokens.pos;
}


winform.btnSnap.oncommand = function(id,event){
	import fsys.dlg;
	import web.form.snap; 
	
	if(key.getState("CTRL")){
		winform.btnSnap.disabled = true;
		
		web.form.snap(wb,function(bmp){
				var hbmp = bmp.copyHandle();
				win.clip.writeBitmap(hbmp,true);
				return true;
		} );  
	}
	else{
		var path = fsys.dlg.save("*.jpg|*.jpg","AI èŠå¤©åŠ©æ‰‹ - ä¿å­˜å¯¹è¯æˆªå›¾",,winform);
		winform.editPrompt.setFocus();
		
		if(!path) return;
		 
		winform.btnSnap.disabled = true;
		
		web.form.snap(wb,path); 
		winform.editPrompt.setFocus();
	}
	
	wb.doScript(`document.documentElement.scrollTop = document.documentElement.scrollHeight + 50;`);
 
	thread.delay(1000);
	winform.btnSnap.disabled = false;
	
	winform.editPrompt.setFocus();
}

winform.btnSearch.oncommand = function(id,event){

	var frmSearch = win.form(text="AI è”ç½‘æœç´¢æ¥å£é…ç½®";right=852;bottom=434;bgcolor=0xFFFFFF;border="dialog frame";max=false)
	frmSearch.add(
	btnSave={cls="plus";text="ä¿å­˜ / æµ‹è¯•æœç´¢";left=657;top=389;right=811;bottom=419;align="left";color=0x3C3C3C;db=1;dr=1;font=LOGFONT(h=-13);iconColor=5724159;iconStyle={align="left";font=LOGFONT(h=-13;name='FontAwesome');padding={left=8}};iconText='\uF0AA';notify=1;textPadding={left=25};z=15};
	chkExa={cls="plus";text="å¯ç”¨ exa.ai è”ç½‘æœç´¢";left=23;top=15;right=242;bottom=51;align="left";dl=1;dt=1;font=LOGFONT(h=-15);iconStyle={align="left";font=LOGFONT(h=-15;name='FontAwesome')};iconText='\uF0C8 ';notify=1;textPadding={left=24};z=2};
	chkTavily={cls="plus";text="å¯ç”¨ Tavily è”ç½‘æœç´¢";left=23;top=111;right=234;bottom=142;align="left";db=1;dl=1;font=LOGFONT(h=-15);iconStyle={align="left";font=LOGFONT(h=-15;name='FontAwesome')};iconText='\uF0C8 ';notify=1;textPadding={left=24};z=3};
	editSearchCount={cls="edit";text="2";left=114;top=218;right=409;bottom=250;dl=1;dt=1;edge=1;multiline=1;num=1;z=7};
	editExaExcludeDomains={cls="edit";left=114;top=303;right=409;bottom=335;db=1;dl=1;dt=1;edge=1;multiline=1;z=11};
	editExaIncludeDomains={cls="edit";left=114;top=261;right=409;bottom=293;dl=1;dt=1;edge=1;multiline=1;z=9};
	editExaKey={cls="edit";left=114;top=64;right=409;bottom=96;dl=1;dt=1;edge=1;multiline=1;password=1;z=1};
	editQuery={cls="edit";left=46;top=391;right=630;bottom=423;db=1;dl=1;dr=1;edge=1;multiline=1;z=13};
	editResult={cls="richedit";left=427;top=23;right=836;bottom=378;db=1;dr=1;dt=1;edge=1;hscroll=1;link=1;multiline=1;vscroll=1;z=14};
	editTavilyKey={cls="edit";left=114;top=152;right=409;bottom=184;db=1;dl=1;edge=1;multiline=1;password=1;z=5};
	lbTavilyKey={cls="static";text="API keyï¼š";left=15;top=157;right=101;bottom=184;align="right";db=1;dl=1;transparent=1;z=6};
	lbSearchCount={cls="static";text="æœ€å¤§ç½‘é¡µæ•°ï¼š";left=-11;top=226;right=101;bottom=253;align="right";dl=1;dt=1;transparent=1;z=8};
	lbExaKey={cls="static";text="API keyï¼š";left=14;top=71;right=101;bottom=98;align="right";dl=1;dt=1;transparent=1;z=4};
	lbExcludeDomains={cls="static";text="æ’é™¤åŸŸåï¼š";left=34;top=311;right=101;bottom=338;align="right";db=1;dl=1;dt=1;transparent=1;z=12};
	lbIncludeDomains={cls="static";text="æœç´¢åŸŸåï¼š";left=34;top=268;right=101;bottom=295;align="right";dl=1;dt=1;transparent=1;z=10};
	lnkExa={cls="syslink";text='<a href="https://exa.ai/">exa.ai</a>';left=269;top=25;right=412;bottom=43;bgcolor=0xFFFFFF;dl=1;dt=1;z=16};
	lnkTavily={cls="syslink";text='<a href="https://app.tavily.com/home">tavily.com</a>';left=261;top=117;right=404;bottom=135;bgcolor=0xFFFFFF;db=1;dl=1;z=17}
	)
	
	frmSearch.editResult.text = /*
- æ¯æ¬¡æ¸…é™¤ä¸Šä¸‹æ–‡ä¹‹å‰ä»…è”ç½‘æœç´¢ä¸€æ¬¡ã€‚
å¤§æ¨¡å‹çš„ä¸Šä¸‹æ–‡æ˜¯æœ‰é™çš„ï¼Œæ³¨æ„é¦–æ¬¡çš„æç¤ºè¯å¯¹æœç´¢å‹å¥½ã€‚

- å·²é™å®šä½¿ç”¨å¯¹ aardio é—®é¢˜æ•ˆæœæœ€å¥½çš„ exa.ai ç«™å†…æœç´¢ï¼Œ
æ”¹ç”¨ ImTip è‡ªå¸¦çš„ AI åŠ©æ‰‹å¯ä¿®æ”¹é€‰é¡¹æˆ–ä½¿ç”¨å…¶ä»– AI æ¥å£ã€‚

- ä½¿ç”¨ aardio å®˜æ–¹ AI æ¥å£è‡ªåŠ¨å¿½ç•¥æ­¤åŠŸèƒ½ï¼Œ
F1 é”®æ²‰æµ¸å¼ AI åŠ©æ‰‹è‡ªåŠ¨å¿½ç•¥æ­¤åŠŸèƒ½ï¼Œ"""é€‰ä¸­ä»£ç """ ä¸Šä¸‹æ–‡é—®ç­”è‡ªåŠ¨å¿½ç•¥æ­¤åŠŸèƒ½ã€‚
aardio çš„ AI æ¥å£å·²è‡ªå¸¦æ›´å¿«æ•ˆæœæ›´å¥½ aardio çŸ¥è¯†åº“ã€‚

ç«‹å³å¼€é€š aardio ä¸“ä¸šç‰ˆ AI æ¥å£ï¼Œæ›´å¿«æ›´å¥½æ›´æ™ºèƒ½ï¼
https://aardio.com/vip/
*/
	
	frmSearch.chkTavily.oncommand = function(id,event){
		if(frmSearch.chkTavily.checked){
			frmSearch.chkExa.checked = false;
		}
	}
	
	frmSearch.chkExa.oncommand = function(id,event){
		if(frmSearch.chkExa.checked){
			frmSearch.chkTavily.checked = false;
		}
	}
	
	if(!config.search){
		config.search = {}
	};
	if(config.search.mode = "exa"){
		frmSearch.chkExa.checked = true;
	}
	elseif(config.search.mode = "tavily"){
		frmSearch.chkTavily.checked = true;
	}
	
	if(!config.search.exa){
		config.search.exa = {};
	}
	
	frmSearch.editSearchCount.text  = config.search.exa.count;
	if(#config.search.exa.includeDomains){
		frmSearch.editExaIncludeDomains.text  = string.join(config.search.exa.includeDomains,",");
	}
	else {
		frmSearch.editExaIncludeDomains.text = "www.aardio.com"
	}
	
	if(#config.search.exa.excludeDomains){
		frmSearch.editExaExcludeDomains.text  = string.join(config.search.exa.excludeDomains,",");
	} 
		
	frmSearch.editExaKey.text = config.search.exa[["key"]]; 
	frmSearch.editTavilyKey.text = config.search.tavily[["key"]];
		
	frmSearch.editExaIncludeDomains.text = "www.aardio.com";
	frmSearch.editExaIncludeDomains.disabled = true;
	frmSearch.editExaExcludeDomains.disabled = true; 
	 
	frmSearch.btnSave.oncommand = function(id,event){
	 
		config.search.exa = {
			key = frmSearch.editExaKey.text;
			count = tonumber(frmSearch.editSearchCount.text);
			includeDomains = #frmSearch.editExaIncludeDomains.text ? string.split(frmSearch.editExaIncludeDomains.text,",") : null;
			excludeDomains = #frmSearch.editExaExcludeDomains.text ? string.split(frmSearch.editExaExcludeDomains.text,",") : null;
		}
		
		if(#config.search.exa.includeDomains){
			if(#config.search.exa.excludeDomains){
				config.search.exa.excludeDomains = null;
				frmSearch.editExaExcludeDomains.showErrorTip("æŒ‡å®šåŒ…å«åŸŸåä»¥åï¼Œä¸èƒ½å†æŒ‡å®šæ’é™¤åŸŸå");
				return;
			}
		}
		
		config.search.tavily = {
			key = frmSearch.editTavilyKey.text;
		}
		
		if(frmSearch.chkExa.checked){
			config.search.mode = "exa"
		}
		elseif(frmSearch.chkTavily.checked){
			config.search.mode = "tavily"	
		}
		else {
			config.search.mode = null;
			return;
		}
		
		if(!#frmSearch.editQuery.text){
			frmSearch.editQuery.showInfoTip("å·²ä¿å­˜è®¾ç½®ï¼Œä½†æµ‹è¯•æœç´¢çš„å†…å®¹ä¸ºç©º");
			return ; 
		}
		
		frmSearch.btnSave.disabledText = {'\uF254';'\uF251';'\uF252';'\uF253';'\uF250'}
		frmSearch.editResult.text = ""
	 
		thread.invoke( function(frmSearch,searchConfig){ 
			import web.rest.jsonClient; 
			
			if(frmSearch.chkExa.checked){
				//å¯¼å…¥ Exa ç´¢æ¥å£ 
				var exaClient = web.rest.jsonClient(); 
				exaClient.setHeaders({ "x-api-key": frmSearch.editExaKey.text} )
				var exa = exaClient.api("https://api.exa.ai/");
				
				//æœç´¢
				var searchData,err = exa.search({
    				query:"aardio ç¼–ç¨‹è¯­è¨€: " + frmSearch.editQuery.text,
    				contents ={ text = true},
    				includeDomains = searchConfig.exa.includeDomains,
    				numResults: tonumber( frmSearch.editSearchCount.text ),
    				type:"keyword" //ä¸€èˆ¬ keyword æœç´¢å°±å¤Ÿäº†ï¼ˆä»·æ ¼ä½ä¸€äº›ï¼‰
				})  
				
				var ret  = searchData[["results"]]
				
				if(!frmSearch.editResult.valid) return;
				if(ret){
					frmSearch.editResult.print(ret);	
				}
				elseif(err){
					frmSearch.editResult.print(err);
				}		
			}
			elseif(frmSearch.chkTavily.checked){
				var http = web.rest.jsonClient(); 
				http.setAuthToken(frmSearch.editTavilyKey.text); 
				var tavily = http.api("https://api.tavily.com");
  
				//æœç´¢
				var searchData,err = tavily.search({ 
    				query = "aardio ç¼–ç¨‹è¯­è¨€: " + frmSearch.editQuery.text,
    				includeDomains = searchConfig.exa.includeDomains,
    				max_results =  tonumber( frmSearch.editSearchCount.text ); //è¿”å›çš„æœç´¢ç»“æœæ•°é‡ï¼Œä¸å¿…è¦å¤ªå¤šï¼Œå‰ä¸¤ä¸‰æ¡å°±å¯ä»¥äº†
				})
				
				//å°†æœç´¢ç»“æœæ·»åŠ åˆ°ç³»ç»Ÿæç¤ºè¯
				var ret = searchData[["results"]]
				
				if(!frmSearch.editResult.valid) return;
				if(ret){
					frmSearch.editResult.print(ret);	
				}
				elseif(err){
					frmSearch.editResult.print(err);
				}	
			} 
			
			frmSearch.btnSave.disabledText = null;
		},frmSearch,config.search)
	}
	
	var chkStyle = {
		color={
			active=0xFF00FF00;
			default=0xFF000000;
			disabled=0xEE666666;
			hover=0xFFFF0000		
		};
		checked={
			iconText='\uF14A'		
		};
	}
	
	frmSearch.btnSave.skin({
		color={
			active=0xFF00FF00;
			default=0xFF3C3C3C;
			disabled=0xFF6D6D6D;
			hover=0xFFFF0000		
		}
		iconColor = {
			disabled=0xFF6D6D6D;
		}
	})
	
	frmSearch.chkTavily.skin(chkStyle); 
	frmSearch.chkExa.skin(chkStyle);
	frmSearch.doModal(winform);
	
	winform.editPrompt.setFocus();
}


//æŒ‰é’®å¤–è§‚æ ·å¼
winform.btnClear.skin({
	color={
		active=0xFF00FF00;
		default=0xFF3C3C3C;
		disabled=0xFF999999;
		hover=0xFFFF0000		
	}
})

//æŒ‰é’®å¤–è§‚æ ·å¼
winform.btnSend.skin({
	color={
		active=0xFF00FF00;
		default=0xFF3C3C3C;
		disabled=0xFF999999;
		hover=0xFFFF0000		
	}
})

//æŒ‰é’®å¤–è§‚æ ·å¼
winform.btnSetting.skin({
	color={
		active=0xFF00FF00;
		default=0xFF3C3C3C;
		disabled=0xFF999999;
		hover=0xFFFF0000		
	}
})

winform.btnSearch.skin({
	color={
		active=0xFF00FF00;
		default=0xFF3C3C3C;
		disabled=0xFF999999;
		hover=0xFFFF0000		
	}
})

winform.btnCopy.skin({
	color={
		active=0xFF00FF00;
		default=0xFF3C3C3C;
		disabled=0xFF999999;
		hover=0xFFFF0000		
	}
})

winform.btnSnap.skin({
	color={
		active=0xFF00FF00;
		default=0xFF3C3C3C;
		disabled=0xFF999999;
		hover=0xFFFF0000		
	}
})

winform.chkFix.skin({
	color={
		active=0xFF00FF00;
		default=0xFF000000;
		disabled=0xFF999999;
		hover=0xFFFF0000		
	};
	checked={
		iconText='\uF14A';	
		color={
			active=0xFF00FF00;
			default=0xFF000000;
			disabled=0xFF999999;
			hover=0xFFFF0000		
		};	
	}
})

if(aiChatConfig.itemNames){
 	winform.cmbAgent.items = aiChatConfig.itemNames;
}

if(aiChatConfig.selItem){
 	winform.cmbAgent.selIndex = aiChatConfig.selItem;
} 

winform.cmbAgent.onOk = function(){ 
 	if(winform.cmbAgent.selIndex){
 		var configItem = aiChatConfig.itemData[winform.cmbAgent.selIndex];
 		if(configItem){
 			aiChatConfig.proxy = null;
 			table.assign(aiChatConfig,configItem);  
 			
 			if(!wb.started()){
 				if( !string.find(winform.editPrompt.text,`"""é€‰ä¸­ä»£ç """`) ){
 					resetMessages();
 				} 
 			} 
 			
 		}		
 	}
}
 
import win.ui.simpleWindow;
win.ui.simpleWindow(winform);

winform.bkPrompt.directDrawBackgroundOnly();
winform.show();

win.loopMessage();